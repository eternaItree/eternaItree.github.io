---
layout: single
title: "Escaping the Google kCTF Container with a Data-Only Exploit"
date: 2023-07-29
classes: wide
header:
  teaser: /assets/images/avatar.jpg
tags:
  - Linux kernel
  - Pwn
  - UAF
  - Tutorial
  - CTF
  - Walkthrough
---

## Introduction
I've been doing some Linux kernel exploit development/study and vulnerability research off and on since last Fall and a few months ago I had some downtime on vacation to sit and challenge myself to write my first data-only exploit for a real bug that was exploited in kCTF. `io_ring` has been a popular target in the program's history up to this point, so I thought I'd find an easy-to-reason-about bug there that had already been exploited as fertile ground for exploit development creativity. The bug I chose to work with was one which resulted in a `struct file` UAF where it was possible to hold an open file descriptor to the freed object. There have been quite a few write-ups on `file` UAF exploits, so I decided as a challenge that my exploit had to be data-only. The parameters of the self-imposed challenge were completely arbitrary, but I just wanted to try writing an exploit that didn't rely on hijacking control flow. I have written quite a few Linux kernel exploits of real kCTF bugs at this point, probably 5-6 as practice, just starting with the vulnerability and going from there, but all of them have ended up in me using ROP, so this was my first try at data-only. I also had not seen a data-only exploit for a `struct file` UAF yet, which was encouraging as it seemed it was worthwile "research". Also, before we get too far, please do not message me to tell me that someone already did xyz years prior. I'm very new to this type of thing and was just doing this as a personal challenge, if some aspects of the exploit are unoriginal, that is by coincidence. I will do my best to cite all my inspiration as we go. 

## The Bug
The [bug](https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=fc7222c3a9f56271fba02aabbfbae999042f1679) is extremely simple (why can't I find one like this?) and was exploited in [kCTF](https://docs.google.com/spreadsheets/d/e/2PACX-1vS1REdTA29OJftst8xN5B5x8iIUcxuK6bXdzF8G1UXCmRtoNsoQ9MbebdRdFnj6qZ0Yd7LwQfvYC2oF/pubhtml#) in November of last year. I didn't look very hard or ask around in the kCTF discord, but I was not able to find a PoC for this particular exploit. I was able to find several good write-ups of exploits leveraging similar vulnerabilities, especially this one by [pqlpql](https://twitter.com/pqlqpql) and [Awarau](https://twitter.com/Awarau1): https://ruia-ruia.github.io/2022/08/05/CVE-2022-29582-io-uring/. 

I won't go into the bug very much because it wasn't really important to the excercise of being creative and writing an exploit using only your own original ideas. 
